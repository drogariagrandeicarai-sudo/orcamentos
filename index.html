<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Orçamentos</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 12px; background:#f2f2f2; }
    h1 { font-size: 18px; margin-bottom:6px; }

    .header {
      background:#fff;
      padding:12px;
      border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.08);
      margin-bottom:12px;
    }

    .search input {
      padding:12px;
      border-radius:8px;
      border:1px solid #ccc;
      font-size:14px;
    }

    .product {
      background:#fff;
      padding:12px;
      margin-bottom:8px;
      border-radius:8px;
      box-shadow:0 1px 4px rgba(0,0,0,0.08);
      cursor:pointer;
    }

    .product:hover { background:#f9f9f9; }

    .name { font-weight: bold; font-size:14px; }
    .etiqueta { color: #1e88e5; font-size: 12px; margin-left: 6px; }
    .price { color:#2e7d32; font-weight:bold; margin-top:4px; text-align:right; }

    .cart {
      background:#fff;
      padding:14px;
      border-radius:8px;
      margin-top:14px;
      box-shadow:0 2px 6px rgba(0,0,0,0.08);
    }

    .item {
      padding:10px 0;
      border-bottom:1px solid #e0e0e0;
    }

    .item:last-child { border-bottom:none; }

    .item-row {
      display:flex;
      align-items:center;
      gap:8px;
      margin-top:6px;
    }

    .item-row input {
      width:60px;
      padding:6px;
    }

    .item-total {
      margin-left:auto;
      font-weight:bold;
    }

    .total {
      margin-top:14px;
      padding:12px;
      background:#f0f0f0;
      border-radius:8px;
      font-size:20px;
      font-weight:bold;
      text-align:center;
    }

    button {
      margin-top:14px;
      padding:14px;
      width:100%;
      background:#25D366;
      border:none;
      color:#fff;
      font-size:18px;
      border-radius:8px;
    }
  </style>
</head>
<body>
  <h1>Orçamento <span id="numOrc"></span></h1>

  <input id="cliente" placeholder="Telefone do cliente" oninput="atualizaHeader()" />
<div id="headerInfo" style="font-size:12px;color:#555;margin-bottom:10px;"></div>

  <div class="search">
    <input id="busca" placeholder="Buscar por nome ou princípio ativo" />
  </div>

  <div id="produtos"></div>

  <div class="cart" id="orcamento">
    <h2>Itens</h2>
    <div id="itens"></div>
    <div class="total" id="total">Total: R$ 0,00</div>
  </div>

  <button onclick="enviar()">ENVIAR ORÇAMENTO</button>

<script>
let produtos = [];
let numeroOrcamento = Math.floor(Math.random() * 9000) + 1000;
let carrinho = [];

fetch('Produtos_01022026.CSV')
  .then(r => r.text())
  .then(text => {
    const linhas = text.split('\n');
    const cab = linhas[0].split(';');
    linhas.slice(1).forEach(l => {
      const c = l.split(';');
      if(c.length > 6){
        produtos.push({
          nome: c[cab.indexOf('Descricao')],
          etiqueta: c[cab.indexOf('Etiqueta')],
          principio: c[cab.indexOf('Principio Ativo')],
          preco: parseFloat(c[cab.indexOf('Preco Referencia')]?.replace(',', '.')) || 0
        });
      }
    });
    renderProdutos([]);
  });

function renderProdutos(lista){
  const div = document.getElementById('produtos');
  div.innerHTML = '';
  lista.forEach(p => {
    const d = document.createElement('div');
    d.className = 'product';
    d.innerHTML = `<div class="name">${p.nome}<span class="etiqueta">${p.etiqueta}</span></div><div class="price">R$ ${p.preco.toFixed(2)}</div>`;
    d.onclick = () => add(p);
    div.appendChild(d);
  });
}

function add(p){
  // adiciona SOMENTE o item clicado
  carrinho.push({ ...p, qtd: 1, desc: 0 });
  renderCarrinho();
});
  renderCarrinho();
}

function atualizaHeader(){
  const tel = document.getElementById('cliente').value;
  document.getElementById('headerInfo').innerText = 'Cliente: ' + tel;
}

document.getElementById('numOrc').innerText = '#' + numeroOrcamento;

function renderCarrinho(){
  const div = document.getElementById('itens');
  div.innerHTML = '';
  let total = 0;

  carrinho.forEach((i, idx) => {
    const t = (i.preco - i.desc) * i.qtd;
    total += t;

    const d = document.createElement('div');
    d.className = 'item';
    d.innerHTML = `
      <div class="name">${i.nome}<span class="etiqueta">${i.etiqueta}</span></div>
      <div style="display:flex;align-items:center;gap:6px;margin-top:4px;">
        <label style="font-size:12px;">Qtd:</label>
        <input type="number" min="1" value="${i.qtd}" style="width:60px;" onchange="atualizaQtd(${idx}, this.value)" />
        <span style="margin-left:auto;">R$ ${t.toFixed(2)}</span>
      </div>
    `;
    div.appendChild(d);
  });

  document.getElementById('total').innerText = 'Total: R$ ' + total.toFixed(2);
}

function atualizaQtd(index, valor){
  const q = parseInt(valor);
  if(!isNaN(q) && q > 0){
    carrinho[index].qtd = q;
    renderCarrinho();
  }
}

busca.oninput = e => {
  const v = e.target.value.toLowerCase();
  renderProdutos(
    produtos.filter(p =>
      (p.nome && p.nome.toLowerCase().includes(v)) ||
      (p.principio && p.principio.toLowerCase().includes(v))
    )
  );
};

function enviar(){
  html2canvas(document.body).then(canvas => {
    canvas.toBlob(blob => {
      const file = new File([blob], 'orcamento.png', { type: 'image/png' });
      const data = new FormData();
      data.append('file', file);
      navigator.share({ files: [file], title: 'Orçamento' });
    });
  });
}
</script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</body>
</html>
